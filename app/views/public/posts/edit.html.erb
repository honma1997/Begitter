<%# 投稿編集ページ %>
<div class="container">
  <%# ページタイトル %>
  <h1 class="mb-4">投稿の編集</h1>
  
  <%# フォーム開始 - 投稿の更新用 %>
  <%# multipart: true は画像アップロードに必要 %>
  <%= form_with(model: @post, url: post_path(@post), method: :patch, local: true, multipart: true) do |f| %>
    
    <%# エラーメッセージ表示部分 %>
    <% if @post.errors.any? %>
      <div class="alert alert-danger">
        <h4><%= @post.errors.count %>件のエラーがあります。</h4>
        <ul>
          <% @post.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    
    <%# タイトル入力フィールド %>
    <div class="mb-3">
      <%= f.label :title, "タイトル", class: "form-label" %>
      <%= f.text_field :title, class: "form-control", placeholder: "タイトルを入力してください" %>
      <div class="form-text">例: 「Railsでいいね機能を実装しました」、「JavaScriptの勉強方法について」</div>
    </div>
    
    <%# 本文入力フィールド %>
    <div class="mb-3">
      <%= f.label :body, "本文", class: "form-label" %>
      <%= f.text_area :body, rows: 10, class: "form-control", placeholder: "本文を入力してください" %>
      <div class="form-text">学習内容や気づきを自由に書いてみましょう。コードも共有できます。</div>
    </div>
    
    <%# タグ選択フィールド %>
    <div class="mb-4">
      <label class="form-label">タグ（複数選択可）</label>
      <div class="tag-selection">
        <% if @tags.present? %>
          <%# タグが存在する場合、チェックボックスで表示 %>
          <div class="row">
            <% @tags.each do |tag| %>
              <div class="col-md-3 mb-2">
                <div class="form-check">
                  <%# 現在選択されているタグにはチェックをつける %>
                  <%= check_box_tag 'post[tag_ids][]', tag.id, @selected_tag_ids.include?(tag.id), 
                                    id: "tag_#{tag.id}", class: "form-check-input" %>
                  <%= label_tag "tag_#{tag.id}", tag.name, class: "form-check-label" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <%# タグが存在しない場合のメッセージ %>
          <p class="text-muted">利用可能なタグがありません。管理者にタグの作成を依頼してください。</p>
        <% end %>
        <div class="form-text">投稿に関連するタグを選択してください。複数選択可能です。</div>
      </div>
    </div>
    
    <%# 現在の画像表示（画像がある場合のみ） %>
    <% if @post.image.attached? %>
      <div class="mb-3">
        <label class="form-label">現在の画像:</label>
        <div class="current-image mb-2">
          <%= image_tag @post.image, class: "img-thumbnail", style: "max-width: 300px;" %>
        </div>
        <div class="form-text">新しい画像をアップロードすると、現在の画像は置き換えられます。</div>
      </div>
    <% end %>
    
    <%# 画像アップロードフィールド %>
    <div class="mb-4">
      <%= f.label :image, "画像（任意・変更する場合のみ）", class: "form-label" %>
      <%= f.file_field :image, class: "form-control", accept: "image/*" %>
      <div class="form-text">PNG, JPG, GIF形式の画像をアップロードできます。</div>
    </div>
    
    <%# 送信ボタンとキャンセルボタン %>
    <div class="mb-3 d-flex gap-2">
      <%# 更新ボタン %>
      <%= f.submit "更新する", class: "btn btn-primary", data: { disable_with: "更新中..." } %>
      
      <%# キャンセルボタン（投稿詳細ページに戻る） %>
      <%= link_to "キャンセル", post_path(@post), class: "btn btn-secondary" %>
    </div>
  <% end %>
  
  <%# 投稿一覧に戻るリンク %>
  <div class="mt-4">
    <%= link_to posts_path, class: "text-decoration-none" do %>
      <i class="fas fa-arrow-left"></i> 投稿一覧に戻る
    <% end %>
  </div>
</div>