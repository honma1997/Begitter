name: Rails CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.USER_NAME }}@${{ secrets.HOST_NAME }} <<EOF
            cd beGitter
            git pull origin main
            ~/.rbenv/shims/bundle install
            ~/.rbenv/shims/bundle exec rails assets:precompile RAILS_ENV=production
            ~/.rbenv/shims/bundle exec rails db:migrate RAILS_ENV=production
            sudo systemctl restart puma
          EOF
